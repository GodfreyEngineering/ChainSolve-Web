# 02 — Domain Model & Schema

> Revision: 1.0 · Date: 2026-02-26

This document is the **canonical reference** for ChainSolve's data model.
Every platform (Web, Mobile, Desktop) and every persistence adapter MUST
serialize and deserialize these structures identically.

---

## 1. Entity relationship overview

```
User (auth.users / profiles)
 └── owns 0..N Project
       ├── has 0..N Canvas (ordered by position)
       │     ├── has 0..N Node
       │     │     ├── has blockType → BlockDef (from catalog)
       │     │     ├── has 0..N InputBinding (per unconnected port)
       │     │     └── has optional parentId → Group node
       │     └── has 0..N Edge (source.out → target.portId)
       ├── has 0..N Variable (project-scoped, shared across canvases)
       ├── has 0..N ProjectAsset (uploaded files: CSV, images)
       └── has optional active_canvas_id → Canvas
```

---

## 2. Project

A project is the top-level container for a user's work.

### 2.1 Database representation (`projects` table)

| Column | Type | Default | Description |
|--------|------|---------|-------------|
| `id` | `uuid` PK | `gen_random_uuid()` | Immutable project identifier. |
| `owner_id` | `uuid` FK → `auth.users` | — | The user who owns this project. All RLS policies scope on this. |
| `name` | `text` NOT NULL | — | Human-readable project name. |
| `description` | `text` | `NULL` | Optional description / notes. |
| `storage_key` | `text` | `NULL` | Legacy: path to monolithic `project.json`. Deprecated in V4. |
| `active_canvas_id` | `uuid` | `NULL` | Last-active canvas (cross-device state). No FK to avoid circular deps; enforced at app level. |
| `variables` | `jsonb` NOT NULL | `'{}'::jsonb` | Project-level variables map. See §5. |
| `created_at` | `timestamptz` | `NOW()` | Immutable creation timestamp. |
| `updated_at` | `timestamptz` | `NOW()` | Last-modified timestamp. Used for conflict detection. |

### 2.2 Invariants

- **INV-P1**: `owner_id` MUST be set on creation and MUST NOT change (ownership transfer is a separate future operation).
- **INV-P2**: `updated_at` MUST be checked before every save. If the DB value is newer than the client's loaded value, the save MUST fail with a conflict error. The client MUST NOT silently overwrite concurrent changes.
- **INV-P3**: `name` MUST be non-empty and SHOULD be ≤ 200 characters.
- **INV-P4**: `variables` MUST be a valid JSON object conforming to the `Record<string, ProjectVariable>` shape (see §5). Invalid shapes MUST be rejected at save time.

---

## 3. Canvas (Sheet)

A canvas is a single graph (nodes + edges) within a project. Multiple canvases enable separation of concerns (e.g. "Inputs", "Calculations", "Results").

### 3.1 Database representation (`canvases` table)

| Column | Type | Default | Description |
|--------|------|---------|-------------|
| `id` | `uuid` PK | — | Canvas identifier (client-generated UUID). |
| `project_id` | `uuid` FK → `projects` | — | Parent project. |
| `owner_id` | `uuid` FK → `auth.users` | — | Denormalized for RLS performance. MUST match `projects.owner_id`. |
| `name` | `text` NOT NULL | — | Tab label (e.g. "Sheet 1"). |
| `position` | `int` NOT NULL | — | 0-based ordering. UNIQUE per `(project_id, position)`. |
| `storage_path` | `text` NOT NULL | — | Path in Supabase Storage: `{userId}/{projectId}/canvases/{canvasId}.json`. |
| `created_at` | `timestamptz` | `NOW()` | |
| `updated_at` | `timestamptz` | `NOW()` | |

### 3.2 Per-canvas JSON format (schemaVersion 4)

Stored in the `projects` storage bucket at the canvas's `storage_path`.

```jsonc
{
  "schemaVersion": 4,
  "canvasId": "<uuid>",
  "projectId": "<uuid>",
  "nodes": [ /* Node[] — React Flow node objects */ ],
  "edges": [ /* Edge[] — React Flow edge objects */ ],
  "datasetRefs": [ /* DatasetRef[] — future: references to uploaded datasets */ ]
}
```

### 3.3 Invariants

- **INV-C1**: Every project MUST have at least one canvas. Deleting the last canvas MUST be prevented.
- **INV-C2**: `position` values MUST be contiguous starting from 0 within a project. Gaps MUST be compacted on canvas deletion.
- **INV-C3**: `storage_path` MUST follow the convention `{owner_id}/{project_id}/canvases/{canvas_id}.json`. Paths outside this pattern MUST be rejected.
- **INV-C4**: The `canvasId` inside the JSON MUST match the row's `id`. Mismatches indicate corruption and MUST be flagged.
- **INV-C5**: `owner_id` MUST always equal the parent project's `owner_id`.

---

## 4. Node

A node is an instance of a block placed on a canvas.

### 4.1 Structure (React Flow + ChainSolve extensions)

```typescript
interface CSNode {
  // React Flow standard fields
  id: string              // Unique within canvas. Generated by nextNodeId().
  type: NodeKind          // 'csSource' | 'csOperation' | 'csDisplay' | 'csData' | 'csPlot' | 'csGroup'
  position: { x: number; y: number }  // Absolute, or relative to parent if grouped.
  parentId?: string       // If inside a group, the group node's ID.
  extent?: 'parent'       // Set to 'parent' when inside a group.

  // ChainSolve data payload
  data: NodeData
}

interface NodeData extends Record<string, unknown> {
  // Required
  blockType: string       // Stable block identifier (e.g. 'add', 'eng.mechanics.force_ma').
  label: string           // Human-readable display label.

  // Source nodes
  value?: number          // Current scalar value (number, slider, variableSource).
  min?: number            // Slider minimum.
  max?: number            // Slider maximum.
  step?: number           // Slider step.

  // Bindings (W12.2)
  inputBindings?: Record<string, InputBinding>  // Per-port value bindings.
  varId?: string          // For variableSource / slider: bound variable ID.

  // Legacy (pre-W12.2, still read for backward compat)
  manualValues?: Record<string, number>    // Direct port overrides.
  portOverrides?: Record<string, boolean>  // Whether a port is manually overridden.

  // Data nodes
  vectorData?: number[]   // vectorInput payload.
  tableData?: { columns: string[]; rows: number[][] }  // tableInput payload.
  csvStoragePath?: string // csvImport: path to uploaded CSV in storage.

  // Plot nodes
  plotConfig?: PlotConfig // Chart configuration (see §4.4).

  // Group nodes
  groupColor?: string     // CSS color for group background.
  groupNotes?: string     // Freeform text notes.
  groupCollapsed?: boolean // Whether child nodes are hidden.
}
```

### 4.2 InputBinding

Specifies the value source for an unconnected (or overridden) input port.

```typescript
type InputBinding =
  | { kind: 'literal'; value: number; raw?: string }
  | { kind: 'const';   constOpId: string }
  | { kind: 'var';     varId: string }
```

| Kind | Resolution | Precedence |
|------|-----------|------------|
| `literal` | The `value` field directly. `raw` preserves user-entered text for display. | Lowest (default). |
| `const` | Looked up from `constantValues` map exported by the Rust catalog. | — |
| `var` | Looked up from `variablesStore` (project variables). | — |
| *(connected edge)* | The source node's output value. | **Highest** — an edge MUST always override any binding on the target port. |

### 4.3 Binding resolution rules

1. If an edge connects to the port → use the edge value. Ignore any binding.
2. Else if `inputBindings[portId]` exists → resolve by kind:
   - `literal` → `binding.value`
   - `const` → `constantValues[binding.constOpId]` (from Rust catalog). If missing → `NaN`.
   - `var` → `variablesStore.variables[binding.varId].value`. If missing → `NaN`.
3. Else if legacy `manualValues[portId]` exists → use that value.
4. Else → use the block's default value for that port (from `BlockDef.defaultData`), or `0` if none.

Resolution is performed in `src/engine/resolveBindings.ts` and injected into
the engine snapshot in `src/engine/bridge.ts`. The Rust engine receives only
resolved `manualValues` — it has no knowledge of bindings.

### 4.4 PlotConfig

```typescript
interface PlotConfig {
  chartType: 'xyLine' | 'xyScatter' | 'histogram' | 'bar' | 'heatmap'
  title?: string
  subtitle?: string
  xLabel?: string
  yLabel?: string
  xScale?: 'linear' | 'log'
  yScale?: 'linear' | 'log'
  showGrid?: boolean
  showLegend?: boolean
  legendPosition?: 'right' | 'bottom' | 'none'
  themePreset?: 'paper-single' | 'paper-double' | 'presentation' | 'report'
  referenceLines?: { axis: 'x' | 'y'; value: number; label?: string }[]
  maxPoints?: number       // Downsampling threshold.
  binCount?: number        // Histogram bin count.
  xColumn?: string         // Table input: column for X axis.
  yColumns?: string[]      // Table input: columns for Y axis.
  showBranding?: boolean   // Include ChainSolve watermark.
}
```

### 4.5 Node invariants

- **INV-N1**: `id` MUST be unique within its canvas.
- **INV-N2**: `blockType` MUST map to a registered `BlockDef` in the catalog. Unknown types produce an `UNKNOWN_BLOCK` engine diagnostic.
- **INV-N3**: If `parentId` is set, the referenced node MUST exist in the same canvas and MUST have `type === 'csGroup'`.
- **INV-N4**: `position` is **relative to the parent** when `parentId` is set, **absolute** otherwise.
- **INV-N5**: Port IDs within a block definition MUST be unique. `targetHandle` on an edge MUST refer to a valid port on the target node.
- **INV-N6**: Numeric fields (`value`, `min`, `max`, `step`, values in `manualValues`) MUST be finite numbers. `NaN` and `Infinity` MUST NOT be persisted.

---

## 5. Edge

An edge is a directed data-flow connection between two nodes.

### 5.1 Structure

```typescript
interface CSEdge {
  id: string              // Unique within canvas.
  source: string          // Source node ID.
  sourceHandle: string    // Output port ID (default: 'out').
  target: string          // Target node ID.
  targetHandle: string    // Input port ID on the target node.
  type?: string           // Edge component type (e.g. 'animated').
}
```

### 5.2 Edge invariants

- **INV-E1**: `source` and `target` MUST reference existing nodes in the same canvas.
- **INV-E2**: A target port MUST NOT have more than one incoming edge. (Fan-in = 1.)
- **INV-E3**: A source port MAY have multiple outgoing edges. (Fan-out = N.)
- **INV-E4**: Self-loops (`source === target`) MUST be prevented at the UI level.
- **INV-E5**: Cycles MUST be detected by the engine. A graph containing a cycle MUST produce a `CYCLE_DETECTED` diagnostic, not silently diverge.

---

## 6. Project variables

Variables are project-scoped named scalars, shared across all canvases.

### 6.1 Structure

```typescript
interface ProjectVariable {
  id: string           // UUID, stable across renames.
  name: string         // Display name (e.g. 'beam_length'). Unique within project.
  value: number        // Current numeric value. MUST be finite.
  description?: string // Optional tooltip / documentation.
}
```

### 6.2 Storage

Stored as JSONB on `projects.variables`:

```json
{
  "var-abc123": { "id": "var-abc123", "name": "beam_length", "value": 5.0, "description": "Span in meters" },
  "var-def456": { "id": "var-def456", "name": "load", "value": 10000, "description": "Applied load in N" }
}
```

### 6.3 Variable invariants

- **INV-V1**: `id` MUST be unique within the project.
- **INV-V2**: `name` MUST be unique within the project (case-insensitive comparison SHOULD be used).
- **INV-V3**: `value` MUST be a finite number. `NaN`, `Infinity`, and non-numeric values MUST be rejected.
- **INV-V4**: Renaming a variable MUST NOT break bindings. Bindings reference `varId`, not `name`.
- **INV-V5**: Deleting a variable SHOULD warn the user if any nodes reference it. The app MUST NOT crash; unresolved `var` bindings resolve to `NaN` with a diagnostic.

### 6.4 Future: user-level preferences

A separate `user_preferences` structure (not variables) will store per-user
settings like theme, default units, and debug console verbosity. This is
architecturally distinct from project variables and MUST NOT be conflated.

---

## 7. Block definitions (catalog)

### 7.1 BlockDef

```typescript
interface BlockDef {
  type: string            // Stable block type ID (= opId in Rust).
  label: string           // Human-readable name.
  category: BlockCategory // Logical grouping (33 categories).
  nodeKind: NodeKind      // React Flow custom node type.
  inputs: { id: string; label: string }[]  // Input port definitions.
  defaultData: NodeData   // Default data payload for new instances.
  proOnly?: boolean       // If true, requires Pro entitlement.
}
```

### 7.2 Block families

| Family | NodeKind(s) | Description | Examples |
|--------|-------------|-------------|----------|
| **Source** | `csSource` | Produces a scalar value. No required inputs. | `number`, `slider`, `pi`, `e`, `variableSource`, `const.*`, `preset.*` |
| **Transform** | `csOperation` | Computes an output from one or more inputs. | `add`, `multiply`, `sin`, `eng.mechanics.force_ma`, `stats.desc.mean` |
| **Sink** | `csDisplay` | Displays a value. No outgoing edges (terminal). | `display` |
| **Data** | `csData` | Produces vector or table data. | `vectorInput`, `tableInput`, `csvImport` |
| **Plot** | `csPlot` | Renders a chart from vector/table inputs. | `xyPlot`, `histogram`, `barChart`, `heatmap` |
| **Group** | `csGroup` | Visual container. No evaluation — purely organizational. | (created via context menu) |

### 7.3 Port binding rules

1. **Connected edge overrides binding**: If a port has an incoming edge, the edge value is used regardless of any `inputBindings` entry.
2. **Binding overrides default**: If no edge, and `inputBindings[portId]` exists, the binding is resolved.
3. **Default fallback**: If neither edge nor binding, the block's default value is used.

### 7.4 Category taxonomy (33 categories)

```
Core:       input, math, trig, constants, logic, output
Data:       data, vectorOps, tableOps, plot
Engineering: engMechanics, engMaterials, engSections, engInertia,
             engFluids, engThermo, engElectrical, engConversions
Finance:    finTvm, finReturns, finDepr
Statistics: statsDesc, statsRel, probComb, probDist, utilCalc
Constants:  constMath, constPhysics, constAtmos, constThermo, constElec
Presets:    presetMaterials, presetFluids
```

### 7.5 Catalog versioning

- The Rust engine exposes `ENGINE_CONTRACT_VERSION` (semver string).
- The TypeScript app reads this on WASM init and compares to its expected version.
- A **major** version mismatch MUST show a fatal error (contract broken).
- A **minor** version mismatch SHOULD show an info diagnostic (new ops available).
- The catalog (`CatalogEntry[]`) is queried from WASM at startup to dynamically register blocks.

---

## 8. Engine evaluation model

### 8.1 EngineSnapshotV1

The JSON payload sent to the Rust/WASM engine for evaluation:

```typescript
interface EngineSnapshotV1 {
  version: 1
  nodes: EngineNodeDef[]
  edges: EngineEdgeDef[]
}

interface EngineNodeDef {
  id: string
  blockType: string
  data: Record<string, unknown>  // Includes resolved manualValues.
}

interface EngineEdgeDef {
  id: string
  source: string
  sourceHandle: string   // Default: 'out'.
  target: string
  targetHandle: string   // Input port ID.
}
```

### 8.2 Evaluation result

```typescript
interface EngineEvalResult {
  values: Record<string, EngineValue>  // nodeId → computed value.
  diagnostics: EngineDiagnostic[]       // Warnings and errors.
  elapsedUs: number                     // Wall-clock microseconds.
  trace?: TraceEntry[]                  // Optional per-node timing (debug mode).
  partial?: boolean                     // True if evaluation was interrupted.
}

type EngineValue =
  | { kind: 'scalar'; value: number }
  | { kind: 'vector'; value: number[] }
  | { kind: 'table';  columns: string[]; rows: number[][] }
  | { kind: 'error';  message: string }
```

### 8.3 Evaluation invariants

- **INV-EV1**: Evaluation MUST be **deterministic** — same snapshot → same result, always.
- **INV-EV2**: Evaluation MUST use **topological sort** (Kahn's algorithm). Cycles MUST produce `CYCLE_DETECTED`, not infinite loops.
- **INV-EV3**: Division by zero MUST produce `Value::error("Division by zero")`, not `NaN` or `Infinity`.
- **INV-EV4**: Unknown block types MUST produce `UNKNOWN_BLOCK` diagnostic, not a crash.
- **INV-EV5**: The engine MUST NOT mutate the input snapshot.
- **INV-EV6**: A watchdog timer (default 5 000 ms) MUST terminate evaluation if it exceeds the timeout. The result MUST include `partial: true`.

### 8.4 Incremental evaluation (PatchOp protocol)

For performance, the engine supports incremental evaluation via patches:

```typescript
type PatchOp =
  | { op: 'addNode';       node: EngineNodeDef }
  | { op: 'removeNode';    nodeId: string }
  | { op: 'updateNodeData'; nodeId: string; data: Record<string, unknown> }
  | { op: 'addEdge';       edge: EngineEdgeDef }
  | { op: 'removeEdge';    edgeId: string }
```

Dirty-tracking propagates changes through the graph, and only affected nodes
are re-evaluated. The result includes `evaluatedCount` and `totalCount`.

---

## 9. Schema versioning and migration

### 9.1 Version history

| Version | Introduced | Structure |
|---------|-----------|-----------|
| V1 | M0 | Monolithic `project.json` with flat node/edge arrays. |
| V2 | W4 | Added `datasetRefs` array. |
| V3 | W7 | Added group node support (`parentId`, `groupColor`, `groupNotes`). |
| V4 | W10.7 | Per-canvas JSON. `project.json` split into per-canvas files. |

### 9.2 Migration rules

- **MIG-1**: Migrations MUST be **pure and idempotent**. Running a migration twice MUST produce the same result as running it once.
- **MIG-2**: Migrations MUST be **forward-only**. Downgrading is not supported.
- **MIG-3**: The app MUST auto-migrate on load. If the stored `schemaVersion` is less than the current version, migration runs transparently.
- **MIG-4**: Legacy `project.json` (V1–V3) MUST NOT be deleted during migration to V4. It is preserved for backward compatibility.
- **MIG-5**: V3 → V4 migration: creates a default canvas row ("Sheet 1", position 0), uploads the migrated graph JSON, and sets `active_canvas_id`.
- **MIG-6**: SQL migrations in `supabase/migrations/` MUST be numbered sequentially (`0001_`, `0002_`, ...) and MUST use `IF NOT EXISTS` / `IF EXISTS` guards for idempotency.

---

## 10. Storage conventions

### 10.1 Supabase Storage buckets

| Bucket | Path pattern | Content |
|--------|-------------|---------|
| `projects` | `{userId}/{projectId}/canvases/{canvasId}.json` | Per-canvas graph JSON (V4). |
| `projects` | `{userId}/{projectId}/project.json` | Legacy monolithic project JSON (preserved). |
| `uploads` | `{userId}/{projectId}/{filename}` | User-uploaded files (CSV, images). |

### 10.2 Path security

- Storage paths MUST start with `{authenticated_user_id}/`.
- RLS policies on storage MUST enforce that a user can only read/write paths under their own user ID prefix.
- Path traversal attempts (e.g. `../`) MUST be rejected.

---

## 11. Error codes

### 11.1 Engine error codes (Rust)

| Code | Meaning |
|------|---------|
| `CYCLE_DETECTED` | The graph contains a cycle. |
| `UNKNOWN_BLOCK` | `blockType` does not match any registered op. |
| `ARITY_MISMATCH` | Wrong number of inputs provided to an op. |
| `TYPE_MISMATCH` | Input value kind does not match expected kind (e.g. scalar where vector expected). |
| `DIVISION_BY_ZERO` | Division or modulo by zero. |

### 11.2 Application error codes (TypeScript)

| Code | Meaning |
|------|---------|
| `[CONFIG_INVALID]` | Missing or invalid Supabase credentials. |
| `[WASM_CSP_BLOCKED]` | CSP blocked WASM instantiation. |
| `[WASM_INIT_FAILED]` | WASM module failed to load or initialize. |
| `[ENGINE_CONTRACT_MISMATCH]` | Engine contract version incompatible with app. |

---

## 12. Out of scope (for now)

- **User-level preferences table**: Documented in §6.4 as future. No schema yet.
- **DatasetRef resolution**: `datasetRefs` array in canvas JSON is reserved but unused. No engine support yet.
- **Cross-canvas edges**: Edges cannot span canvases. Each canvas is an independent graph.
- **Collaborative editing schema**: No CRDT or OT metadata in the schema.
- **Versioned project history**: No built-in undo log or version timeline at the project level.

---

## 13. Future extensions

1. **Cross-canvas references**: Allow a node in Canvas A to reference a computed value from Canvas B.
2. **Dataset catalog**: Named datasets stored at project level, referenced by `datasetRefs` in canvas JSON.
3. **User preferences schema**: Stored in `profiles` or a new `user_preferences` table.
4. **Project history / snapshots**: Append-only log of project states for undo/audit.
5. **Custom block schema**: User-defined block definitions with structured I/O specs.
6. **Org-scoped variables**: Variables shared across projects within an organization.

---

## Change Log

| Date | Author | Change |
|------|--------|--------|
| 2026-02-26 | — | Initial version (v1.0). |
