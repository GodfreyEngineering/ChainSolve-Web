<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ChainSolve — App Smoke Test</title>

  <!-- Supabase JS (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.97.0"></script>

  <!-- Sentry (optional) -->
  <script src="https://js-de.sentry-cdn.com/14ba135522882fcdc7796e315dcf9c8a.min.js" crossorigin="anonymous"></script>

  <!-- PostHog (optional) -->
  <script>
    !function(t,e){var o,n,p,r;e.__SV||(window.posthog&&window.posthog.__loaded)||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.crossOrigin="anonymous",p.async=!0,p.src=s.api_host.replace(".i.posthog.com","-assets.i.posthog.com")+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="init ls vs Ce hs cs ns us capture calculateEventProperties gs register register_once register_for_session unregister unregister_for_session xs getFeatureFlag getFeatureFlagPayload getFeatureFlagResult isFeatureEnabled reloadFeatureFlags updateFlags updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures on onFeatureFlags onSurveysLoaded onSessionId getSurveys getActiveMatchingSurveys renderSurvey displaySurvey cancelPendingSurvey canRenderSurvey canRenderSurveyAsync identify setPersonProperties group resetGroups setPersonPropertiesForFlags resetPersonPropertiesForFlags setGroupPropertiesForFlags resetGroupPropertiesForFlags reset get_distinct_id getGroups get_session_id get_session_replay_url alias set_config startSessionRecording stopSessionRecording sessionRecordingStarted captureException startExceptionAutocapture stopExceptionAutocapture loadToolbar get_property getSessionProperty ys createPersonProfile setInternalOrTestUser ws rs $s opt_in_capturing opt_out_capturing has_opted_in_capturing has_opted_out_capturing get_explicit_consent_status is_capturing clear_opt_in_out_capturing fs debug M bs getPageViewId captureTraceFeedback captureTraceMetric Zr".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
  </script>

  <style>
    :root { color-scheme: dark; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#0b0c10; color:#e9eef2; }
    .wrap { max-width: 1040px; margin: 0 auto; padding: 24px; }
    .topbar { display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    .brand { display:flex; align-items:center; gap:12px; }
    .dot { width:10px; height:10px; border-radius:999px; background:#1cabb0; box-shadow:0 0 0 7px rgba(28,171,176,.16); }
    h1 { margin:0; font-size: 22px; letter-spacing:.02em; }
    .pill { display:inline-flex; padding: 7px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.12); background: rgba(0,0,0,.22); gap:8px; align-items:center; }
    .grid { display:grid; grid-template-columns: 1fr; gap: 12px; margin-top: 14px; }
    @media (min-width: 980px){ .grid { grid-template-columns: 1fr 1fr; } }
    .card { border:1px solid rgba(255,255,255,.12); border-radius:16px; background: rgba(255,255,255,.04); padding:16px; }
    .card h2 { margin:0 0 10px 0; font-size: 15px; letter-spacing:.08em; text-transform:uppercase; opacity:.92; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    input, button { border-radius:12px; border:1px solid rgba(255,255,255,.14); background: rgba(0,0,0,.25); color:#e9eef2; padding:10px 12px; }
    input { min-width: 260px; }
    button { cursor:pointer; font-weight: 750; letter-spacing:.02em; }
    button.primary { border-color: rgba(28,171,176,.55); background: rgba(28,171,176,.12); }
    button.danger { border-color: rgba(255,80,80,.55); background: rgba(255,80,80,.12); }
    button:disabled { opacity:.5; cursor:not-allowed; }
    pre { white-space: pre-wrap; word-break: break-word; background: rgba(0,0,0,.35); padding: 12px; border-radius: 12px; border:1px solid rgba(255,255,255,.10); margin:0; }
    .ok { color: #7CFFB2; }
    .bad { color: #FF8C8C; }
    .muted { opacity:.78; }
    .kv { display:grid; grid-template-columns: 180px 1fr; gap:8px 10px; align-items:center; }
    .k { font-weight: 750; opacity:.75; }
    .v { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size: 12px; opacity:.92; }
    .small { font-size: 12.5px; line-height: 1.35; }
    .sep { height:1px; background: rgba(255,255,255,.10); margin: 12px 0; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <span class="dot"></span>
        <div>
          <h1>ChainSolve — Setup Smoke Test</h1>
          <div class="muted small">Auth ✅ · Projects ✅ · Billing/Entitlements ✅ (when Edge functions + webhook are correct)</div>
        </div>
      </div>
      <div class="pill">
        Domain <b>app.chainsolve.co.uk</b>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>1) Config</h2>
        <div class="kv">
          <div class="k">Supabase URL</div><div class="v" id="sbUrl">—</div>
          <div class="k">Functions Base</div><div class="v" id="fnBase">—</div>
          <div class="k">APP_ORIGIN</div><div class="v" id="appOrigin">—</div>
        </div>
        <div class="sep"></div>
        <div class="small muted">
          If billing calls fail: open <b>DevTools → Network</b> and click Upgrade again.
          If Supabase logs show <b>execution_id: null</b>, your function is blocked at the gateway (verify_jwt issue).
        </div>
      </div>

      <div class="card">
        <h2>2) Auth (Magic Link)</h2>
        <div class="row">
          <input id="email" type="email" placeholder="you@domain.com" />
          <button id="btnLogin" class="primary">Send magic link</button>
          <button id="btnLogout" class="danger">Logout</button>
        </div>
        <p id="authState" class="small" style="margin:10px 0 0 0;"></p>
      </div>

      <div class="card">
        <h2>3) Entitlements + Billing</h2>
        <div class="row">
          <button id="btnEnt">Check my_entitlements</button>
          <button id="btnUpgrade" class="primary">Upgrade (£10/mo)</button>
          <button id="btnPortal">Manage subscription</button>
        </div>
        <p id="entState" class="small" style="margin:10px 0 0 0;"></p>
        <div class="sep"></div>
        <div class="small muted">
          <b>Expected:</b> Upgrade returns a Stripe Checkout URL. Portal returns a Stripe Billing Portal URL.<br>
          <b>If you see 401 / non-2xx:</b> your Edge function is likely still <code>verify_jwt=true</code> at the gateway OR missing SB_* secrets.
        </div>
      </div>

      <div class="card">
        <h2>4) Projects table</h2>
        <div class="row">
          <input id="projName" type="text" placeholder="Project name" />
          <button id="btnSaveProj" class="primary">Save test project</button>
          <button id="btnListProj">List my projects</button>
        </div>
        <div class="sep"></div>
        <div class="small muted">
          This uses RLS to only allow you to read/write your own rows. If this fails, fix table/RLS first.
        </div>
      </div>

      <div class="card" style="grid-column: 1 / -1;">
        <h2>Logs</h2>
        <pre id="log" style="min-height: 160px;"></pre>
      </div>
    </div>
  </div>

<script>
/* ============================================================
   ChainSolve Smoke Test — robust, no magic globals, no ambiguity
   - Safe logging + button instrumentation
   - Billing functions call Supabase Edge Functions
   - Uses auth token automatically via supabase-js
============================================================ */

  // =========================
  // 0) CONFIG — paste only these if needed
  // =========================
  const SUPABASE_URL = "https://zjgfosqtnlhlfgpohnnu.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpqZ2Zvc3F0bmxobGZncG9obm51Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NTE5MzYsImV4cCI6MjA4NzQyNzkzNn0.vyKMEWde9gEODj5ocUTCnz3l9AyXMuegLcEmMfnqmjE";

  const APP_ORIGIN = "https://app.chainsolve.co.uk";

  // Optional telemetry
  const SENTRY_DSN = "https://14ba135522882fcdc7796e315dcf9c8a@o4510940617834496.ingest.de.sentry.io/4510940620128336";
  const POSTHOG_KEY = "phc_dy0mQLseJ8DypIG0uIskjNeKGAY7hgDLpZcm32cixm";
  const POSTHOG_HOST = "https://eu.i.posthog.com";

  // =========================
  // 1) Safe helpers
  // =========================
  const $ = (id) => document.getElementById(id);
  const $log = $("log");

  const now = () => new Date().toISOString().replace("T"," ").replace("Z","");
  const log = (...args) => {
    const line = args.map(a => (typeof a === "string" ? a : JSON.stringify(a, null, 2))).join(" ");
    $log.textContent = `[${now()}] ${line}\n\n` + $log.textContent;
    $log.textContent = $log.textContent.slice(0, 18000);
    console.log(...args);
  };

  const setAuthState = (txt, ok=true) => {
    $("authState").innerHTML = ok ? `<span class="ok">✔</span> ${txt}` : `<span class="bad">✘</span> ${txt}`;
  };
  const setEntState = (txt, ok=true) => {
    $("entState").innerHTML = ok ? `<span class="ok">✔</span> ${txt}` : `<span class="bad">✘</span> ${txt}`;
  };

  const disable = (id, v=true) => { const b=$(id); if (b) b.disabled = !!v; };

  // =========================
  // 2) Init telemetry (optional)
  // =========================
  try {
    if (SENTRY_DSN && window.Sentry) {
      window.Sentry.init({ dsn: SENTRY_DSN });
      log("Sentry: init ok");
    }
  } catch (e) { log("Sentry init error:", String(e)); }

  try {
    if (POSTHOG_KEY) {
      window.posthog.init(POSTHOG_KEY, {
        api_host: POSTHOG_HOST,
        autocapture: true,
        person_profiles: "identified_only"
      });
      log("PostHog: init ok");
    }
  } catch (e) { log("PostHog init error:", String(e)); }

  // =========================
  // 3) Init Supabase
  // =========================
  if (!window.supabase?.createClient) {
    alert("Supabase SDK failed to load.");
    throw new Error("Supabase SDK failed to load");
  }

  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  $("sbUrl").textContent = SUPABASE_URL;
  $("fnBase").textContent = `${SUPABASE_URL}/functions/v1/*`;
  $("appOrigin").textContent = APP_ORIGIN;

  async function refreshUser() {
    const { data, error } = await sb.auth.getUser();
    if (error) {
      setAuthState(`Auth getUser error: ${error.message}`, false);
      return null;
    }
    if (data?.user) {
      setAuthState(`Logged in as <b>${data.user.email}</b> (uid: ${data.user.id})`);
      try { if (POSTHOG_KEY) window.posthog.identify(data.user.id, { email: data.user.email }); } catch {}
      return data.user;
    } else {
      setAuthState("Not logged in");
      try { if (POSTHOG_KEY) window.posthog.reset(); } catch {}
      return null;
    }
  }

  sb.auth.onAuthStateChange(async (event, session) => {
    log("Auth state change:", { event, hasSession: !!session });
    await refreshUser();
  });

  // =========================
  // 4) Instrument all buttons (so “nothing happens” is impossible)
  // =========================
  ["btnLogin","btnLogout","btnEnt","btnUpgrade","btnPortal","btnSaveProj","btnListProj"].forEach((id) => {
    const el = $(id);
    if (!el) return;
    el.addEventListener("click", () => log("Clicked:", id));
  });

  // =========================
  // 5) Auth actions
  // =========================
  $("btnLogin").addEventListener("click", async () => {
    const email = $("email").value.trim();
    if (!email) return alert("Enter an email first");

    disable("btnLogin", true);
    try {
      log("Sending magic link to:", email);
      const { error } = await sb.auth.signInWithOtp({
        email,
        options: { emailRedirectTo: APP_ORIGIN }
      });
      if (error) { log("Auth error:", error); setAuthState(error.message, false); return; }
      setAuthState("Magic link sent — check your email.");
    } finally {
      disable("btnLogin", false);
    }
  });

  $("btnLogout").addEventListener("click", async () => {
    disable("btnLogout", true);
    try {
      const { error } = await sb.auth.signOut();
      if (error) log("Logout error:", error);
      setAuthState("Logged out");
      setEntState("");
    } finally {
      disable("btnLogout", false);
    }
  });

  // =========================
  // 6) Entitlements
  // =========================
  $("btnEnt").addEventListener("click", async () => {
    disable("btnEnt", true);
    try {
      const user = await refreshUser();
      if (!user) return setEntState("Login first.", false);

      const { data, error } = await sb
        .from("my_entitlements")
        .select("is_pro,status,current_period_end,cancel_at_period_end,stripe_customer_id")
        .eq("user_id", user.id)
        .maybeSingle();

      if (error) { log("Entitlements error:", error); setEntState(error.message, false); return; }
      if (!data) { setEntState("No subscription row yet (expected before first purchase)."); return; }

      setEntState(`PRO: <b>${data.is_pro}</b> · status: ${data.status || "—"} · period_end: ${data.current_period_end || "—"} · cancel_at_period_end: ${data.cancel_at_period_end ?? "—"}`);
      log("Entitlements:", data);
    } finally {
      disable("btnEnt", false);
    }
  });

  // =========================
  // 7) Billing — Checkout
  // =========================
  $("btnUpgrade").addEventListener("click", async () => {
    disable("btnUpgrade", true);
    try {
      const user = await refreshUser();
      if (!user) return alert("Login first.");

      log("Calling create-checkout-session…");
      const { data, error } = await sb.functions.invoke("create-checkout-session", {
        body: {
          success_url: `${APP_ORIGIN}/?success=1`,
          cancel_url: `${APP_ORIGIN}/?canceled=1`,
        }
      });

      if (error) {
        log("Checkout function error:", error);
        alert("Checkout error: " + (error.message || "Unknown error"));
        return;
      }

      if (!data?.url) {
        log("Checkout: no url returned:", data);
        alert("No checkout URL returned");
        return;
      }

      log("Redirecting to Stripe Checkout:", data.url);
      window.location.href = data.url;
    } finally {
      disable("btnUpgrade", false);
    }
  });

  // =========================
  // 8) Billing — Portal
  // =========================
  $("btnPortal").addEventListener("click", async () => {
    disable("btnPortal", true);
    try {
      const user = await refreshUser();
      if (!user) return alert("Login first.");

      log("Calling create-portal-session…");
      const { data, error } = await sb.functions.invoke("create-portal-session", {
        body: { return_url: `${APP_ORIGIN}/` }
      });

      if (error) {
        log("Portal function error:", error);
        alert("Portal error: " + (error.message || "Unknown error"));
        return;
      }

      if (!data?.url) {
        log("Portal: no url returned:", data);
        alert("No portal URL returned");
        return;
      }

      log("Redirecting to Stripe Portal:", data.url);
      window.location.href = data.url;
    } finally {
      disable("btnPortal", false);
    }
  });

  // =========================
  // 9) Projects
  // =========================
  $("btnSaveProj").addEventListener("click", async () => {
    disable("btnSaveProj", true);
    try {
      const user = await refreshUser();
      if (!user) return alert("Login first.");

      const name = ($("projName").value || "Test project").trim();
      const payload = { nodes: [{ id: "n1", type: "input", x: 10, y: 20 }], edges: [] };

      const { data, error } = await sb
        .from("projects")
        .insert({ user_id: user.id, name, data: payload })
        .select("*")
        .single();

      if (error) { log("Save project error:", error); alert(error.message); return; }
      log("Saved project:", data);
      alert("Saved project OK");
    } finally {
      disable("btnSaveProj", false);
    }
  });

  $("btnListProj").addEventListener("click", async () => {
    disable("btnListProj", true);
    try {
      const user = await refreshUser();
      if (!user) return alert("Login first.");

      const { data, error } = await sb
        .from("projects")
        .select("id,name,updated_at")
        .order("updated_at", { ascending: false })
        .limit(20);

      if (error) { log("List projects error:", error); alert(error.message); return; }
      log("My projects:", data);
      alert(`Found ${data.length} projects (see logs).`);
    } finally {
      disable("btnListProj", false);
    }
  });

  // =========================
  // 10) Boot
  // =========================
  (async () => {
    log("Smoke test loaded.");
    await refreshUser();
    setEntState("Click “Check my_entitlements” to confirm PRO status.");
  })();

</script>
</body>
</html>
